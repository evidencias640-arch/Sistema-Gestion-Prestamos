<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Panel de Clientes - SGL Pro</title>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root {
      --primary: #1a365d;
      --primary-light: #2d5a87;
      --secondary: #3182ce;
      --accent: #805ad5;
      --success: #38a169;
      --warning: #d69e2e;
      --danger: #e53e3e;
      --light-bg: #f8fafc;
      --card-bg: #ffffff;
      --text-primary: #2d3748;
      --text-secondary: #4a5568;
      --border-color: #e2e8f0;
      --shadow-light: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-medium: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      --shadow-strong: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
      --gradient-primary: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
      --gradient-success: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      --gradient-warning: linear-gradient(135deg, #ecc94b 0%, #d69e2e 100%);
      --gradient-accent: linear-gradient(135deg, #9f7aea 0%, #805ad5 100%);
    }
    
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      background: var(--light-bg);
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      color: var(--text-primary);
      line-height: 1.6;
    }
    
    /* LAYOUT */
    .wrapper {
      display: flex;
      min-height: 100vh;
    }
    
    .sidebar {
      width: 280px;
      background: var(--gradient-primary);
      color: white;
      padding: 0;
      position: fixed;
      height: 100vh;
      overflow-y: auto;
      box-shadow: var(--shadow-strong);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .sidebar-header {
      padding: 2rem 1.5rem 1rem;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }
    
    .brand {
      font-weight: 700;
      font-size: 1.5rem;
      margin-bottom: 0.5rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .brand-icon {
      width: 40px;
      height: 40px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
    }
    
    .welcome-text {
      color: rgba(255, 255, 255, 0.8);
      font-size: 0.9rem;
      font-weight: 400;
    }
    
    .sidebar-nav {
      padding: 1rem 0;
    }
    
    .nav-item {
      margin-bottom: 0.25rem;
    }
    
    .nav-link {
      display: flex;
      align-items: center;
      padding: 1rem 1.5rem;
      color: rgba(255, 255, 255, 0.85);
      text-decoration: none;
      border-radius: 0;
      transition: all 0.3s ease;
      position: relative;
      font-weight: 500;
    }
    
    .nav-link:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
      transform: translateX(4px);
    }
    
    .nav-link.active {
      background: rgba(255, 255, 255, 0.15);
      color: white;
      border-right: 4px solid #ffd700;
    }
    
    .nav-link i {
      width: 20px;
      margin-right: 1rem;
      font-size: 1.1rem;
    }
    
    .sidebar-footer {
      position: absolute;
      bottom: 1rem;
      left: 1.5rem;
      right: 1.5rem;
    }
    
    .main {
      margin-left: 280px;
      padding: 2rem;
      width: calc(100% - 280px);
      min-height: 100vh;
      transition: all 0.3s ease;
    }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
      .sidebar {
        left: -280px;
      }
      
      .sidebar.open {
        left: 0;
      }
      
      .main {
        margin-left: 0;
        width: 100%;
      }
      
      .mobile-toggle {
        display: block !important;
      }
    }
    
    /* COMPONENTS */
    .page-header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid var(--border-color);
    }
    
    .page-title {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
    }
    
    .page-subtitle {
      color: var(--text-secondary);
      font-size: 1rem;
    }
    
    .mobile-toggle {
      display: none;
      margin-bottom: 1rem;
    }
    
    /* CARDS */
    .stat-card {
      background: var(--card-bg);
      border-radius: 16px;
      padding: 1.5rem;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-color);
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }
    
    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 4px;
      background: var(--gradient-primary);
    }
    
    .stat-card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }
    
    .stat-card.success::before {
      background: var(--gradient-success);
    }
    
    .stat-card.warning::before {
      background: var(--gradient-warning);
    }
    
    .stat-card.accent::before {
      background: var(--gradient-accent);
    }
    
    .stat-icon {
      width: 48px;
      height: 48px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5rem;
      margin-bottom: 1rem;
      color: white;
    }
    
    .stat-icon.primary {
      background: var(--gradient-primary);
    }
    
    .stat-icon.success {
      background: var(--gradient-success);
    }
    
    .stat-icon.warning {
      background: var(--gradient-warning);
    }
    
    .stat-icon.accent {
      background: var(--gradient-accent);
    }
    
    .stat-value {
      font-size: 2rem;
      font-weight: 700;
      color: var(--text-primary);
      margin-bottom: 0.25rem;
    }
    
    .stat-label {
      color: var(--text-secondary);
      font-size: 0.9rem;
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .content-card {
      background: var(--card-bg);
      border-radius: 16px;
      box-shadow: var(--shadow-light);
      border: 1px solid var(--border-color);
      overflow: hidden;
      margin-bottom: 2rem;
    }
    
    .card-header-modern {
      background: var(--gradient-primary);
      color: white;
      padding: 1.5rem;
      font-weight: 600;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    
    .card-body-modern {
      padding: 1.5rem;
    }
    
    /* CHARTS */
    .chart-container {
      position: relative;
      height: 300px;
      margin: 1rem 0;
    }
    
    /* TABLES */
    .table-modern {
      margin: 0;
      border-collapse: separate;
      border-spacing: 0;
    }
    
    .table-modern th {
      background: var(--light-bg);
      color: var(--text-primary);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.8rem;
      letter-spacing: 0.5px;
      padding: 1rem;
      border: none;
      border-bottom: 2px solid var(--border-color);
    }
    
    .table-modern td {
      padding: 1rem;
      border: none;
      border-bottom: 1px solid var(--border-color);
      vertical-align: middle;
    }
    
    .table-modern tbody tr:hover {
      background: var(--light-bg);
    }
    
    /* BADGES */
    .badge-modern {
      padding: 0.5rem 1rem;
      font-size: 0.8rem;
      font-weight: 500;
      border-radius: 20px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-success {
      background: #e6fffa;
      color: #00695c;
    }
    
    .badge-warning {
      background: #fff8e1;
      color: #e65100;
    }
    
    .badge-secondary {
      background: #f5f5f5;
      color: #616161;
    }
    
    /* BUTTONS */
    .btn-modern {
      padding: 0.75rem 1.5rem;
      border-radius: 10px;
      font-weight: 500;
      font-size: 0.9rem;
      border: none;
      transition: all 0.3s ease;
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .btn-primary-modern {
      background: var(--gradient-primary);
      color: white;
    }
    
    .btn-primary-modern:hover {
      transform: translateY(-1px);
      box-shadow: var(--shadow-medium);
    }
    
    .btn-sm-modern {
      padding: 0.5rem 1rem;
      font-size: 0.85rem;
    }
    
    /* FORMS */
    .form-control-modern {
      border: 2px solid var(--border-color);
      border-radius: 10px;
      padding: 0.75rem 1rem;
      font-size: 0.9rem;
      transition: all 0.3s ease;
    }
    
    .form-control-modern:focus {
      border-color: var(--secondary);
      box-shadow: 0 0 0 3px rgba(49, 130, 206, 0.1);
    }
    
    .form-label-modern {
      font-weight: 500;
      color: var(--text-primary);
      margin-bottom: 0.5rem;
      font-size: 0.9rem;
    }
    
    /* ALERTS */
    .alert-fixed {
      position: fixed;
      top: 2rem;
      right: 2rem;
      z-index: 2000;
      min-width: 320px;
      border-radius: 12px;
      border: none;
      box-shadow: var(--shadow-strong);
      animation: slideInRight 0.3s ease;
    }
    
    @keyframes slideInRight {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    /* ACTIVITY FEED */
    .activity-item {
      display: flex;
      align-items: center;
      padding: 1rem;
      border-bottom: 1px solid var(--border-color);
      transition: all 0.3s ease;
    }
    
    .activity-item:hover {
      background: var(--light-bg);
    }
    
    .activity-item:last-child {
      border-bottom: none;
    }
    
    .activity-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      background: var(--gradient-success);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      margin-right: 1rem;
      font-size: 1rem;
    }
    
    .activity-content {
      flex: 1;
    }
    
    .activity-title {
      font-weight: 600;
      margin-bottom: 0.25rem;
    }
    
    .activity-subtitle {
      color: var(--text-secondary);
      font-size: 0.9rem;
    }
    
    .activity-amount {
      font-weight: 700;
      color: var(--success);
      font-size: 1.1rem;
    }
    
    /* LOADING */
    .loading-spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid #f3f3f3;
      border-top: 2px solid var(--secondary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* SECTIONS */
    .section {
      display: none;
    }
    
    .section.active {
      display: block;
      animation: fadeIn 0.3s ease;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <div class="wrapper">
    <nav id="sidebar" class="sidebar">
      <div class="sidebar-header">
        <div class="brand">
          <div class="brand-icon">
            <i class="fas fa-chart-line"></i>
          </div>
          SGL Pro
        </div>
        <div class="welcome-text">
          Bienvenido, <strong id="clientNameTitle">Cliente</strong>
        </div>
      </div>
      
      <div class="sidebar-nav">
        <div class="nav-item">
          <a href="#" class="nav-link active" data-section="dashboard">
            <i class="fas fa-tachometer-alt"></i>
            Panel Principal
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="loans">
            <i class="fas fa-money-bill-wave"></i>
            Mis Préstamos
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="contracts">
            <i class="fas fa-file-contract"></i>
            Contratos
          </a>
        </div>
        <div class="nav-item">
          <a href="#" class="nav-link" data-section="profile">
            <i class="fas fa-user-circle"></i>
            Mi Perfil
          </a>
        </div>
      </div>
      
      <div class="sidebar-footer">
        <a href="#" id="logoutBtn" class="nav-link" style="color: rgba(255,255,255,0.6);">
          <i class="fas fa-sign-out-alt"></i>
          Cerrar Sesión
        </a>
      </div>
    </nav>

    <main class="main">
      <button id="mobileToggle" class="btn btn-light mobile-toggle">
        <i class="fas fa-bars"></i>
      </button>
      
      <div class="page-header">
        <h1 class="page-title">Hola, <span id="clientNameHeadline">Cliente</span></h1>
        <p class="page-subtitle">Gestiona tus préstamos y consulta tu información financiera</p>
      </div>

      <div id="alertPlaceholder"></div>

      <section id="dashboard" class="section active">
        <div class="row g-4 mb-4">
          <div class="col-12 col-md-6 col-xl-3">
            <div class="stat-card primary">
              <div class="stat-icon primary">
                <i class="fas fa-dollar-sign"></i>
              </div>
              <div class="stat-value" id="totalPendingAmount">$0</div>
              <div class="stat-label">Saldo Pendiente</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="stat-card success">
              <div class="stat-icon success">
                <i class="fas fa-check-circle"></i>
              </div>
              <div class="stat-value" id="activeLoansCount">0</div>
              <div class="stat-label">Préstamos Activos</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="stat-card warning">
              <div class="stat-icon warning">
                <i class="fas fa-handshake"></i>
              </div>
              <div class="stat-value" id="finalizedLoansCount">0</div>
              <div class="stat-label">Préstamos Finalizados</div>
            </div>
          </div>
          <div class="col-12 col-md-6 col-xl-3">
            <div class="stat-card accent">
              <div class="stat-icon accent">
                <i class="fas fa-percentage"></i>
              </div>
              <div class="stat-value" id="averageInterestRate">0%</div>
              <div class="stat-label">Tasa Promedio</div>
            </div>
          </div>
        </div>
        <div class="row">
          <div class="col-12 col-lg-8">
            <div class="content-card">
              <div class="card-header-modern">
                <i class="fas fa-chart-area"></i> Evolución de Pagos
              </div>
              <div class="card-body-modern">
                <div class="chart-container">
                  <canvas id="paymentsChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="content-card">
              <div class="card-header-modern">
                <i class="fas fa-clock"></i> Actividad Reciente
              </div>
              <div class="card-body-modern" style="padding: 0;">
                <div id="recentActivityContainer">
                  <div class="text-center p-4">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    <small class="text-muted">Cargando actividad...</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
        <div class="row mt-4">
          <div class="col-12 col-md-6">
            <div class="content-card">
              <div class="card-header-modern">
                <i class="fas fa-chart-pie"></i> Estado de Préstamos
              </div>
              <div class="card-body-modern">
                <div class="chart-container" style="height: 250px;">
                  <canvas id="loanStatusChart"></canvas>
                </div>
              </div>
            </div>
          </div>
          <div class="col-12 col-md-6">
            <div class="content-card">
              <div class="card-header-modern">
                <i class="fas fa-calendar-alt"></i> Próximos Vencimientos
              </div>
              <div class="card-body-modern">
                <div id="upcomingPayments">
                  <div class="text-center">
                    <div class="loading-spinner mx-auto mb-2"></div>
                    <small class="text-muted">Cargando vencimientos...</small>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section id="loans" class="section">
        <div class="content-card">
          <div class="card-header-modern">
            <i class="fas fa-money-bill-wave"></i> Mis Préstamos
          </div>
          <div class="card-body-modern">
            <div class="table-responsive">
              <table class="table table-modern">
                <thead>
                  <tr>
                    <th>ID Préstamo</th>
                    <th>Monto Original</th>
                    <th>Saldo Actual</th>
                    <th>Cuotas</th>
                    <th>Tasa</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="loansTableBody">
                  <tr>
                    <td colspan="7" class="text-center py-4">
                      <div class="loading-spinner mx-auto mb-2"></div>
                      <small class="text-muted">Cargando préstamos...</small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <section id="contracts" class="section">
        <div class="content-card">
          <div class="card-header-modern">
            <i class="fas fa-file-contract"></i> Contratos y Documentos
          </div>
          <div class="card-body-modern">
            <div class="table-responsive">
              <table class="table table-modern">
                <thead>
                  <tr>
                    <th>ID Documento</th>
                    <th>Préstamo</th>
                    <th>Fecha</th>
                    <th>Tipo</th>
                    <th>Estado</th>
                    <th>Acciones</th>
                  </tr>
                </thead>
                <tbody id="contractsTableBody">
                  <tr>
                    <td colspan="6" class="text-center py-4">
                      <div class="loading-spinner mx-auto mb-2"></div>
                      <small class="text-muted">Cargando documentos...</small>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </section>
      <section id="profile" class="section">
        <div class="row">
          <div class="col-12 col-lg-8">
            <div class="content-card">
              <div class="card-header-modern">
                <i class="fas fa-user-circle"></i> Información Personal
              </div>
              <div class="card-body-modern">
                <form id="profileForm">
                  <div class="row g-3">
                    <div class="col-12 col-md-6">
                      <label class="form-label-modern">Documento (no editable)</label>
                      <input id="profileDoc" class="form-control form-control-modern" readonly>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label-modern">Nombre Completo</label>
                      <input id="profileName" class="form-control form-control-modern" required>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label-modern">Teléfono</label>
                      <input id="profilePhone" class="form-control form-control-modern" required>
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label-modern">Dirección</label>
                      <input id="profileAddress" class="form-control form-control-modern">
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label-modern">Color Favorito</label>
                      <input id="profileColor" class="form-control form-control-modern">
                    </div>
                    <div class="col-12 col-md-6">
                      <label class="form-label-modern">Animal Favorito</label>
                      <input id="profileAnimal" class="form-control form-control-modern">
                    </div>
                    <div class="col-12 text-end">
                      <button type="submit" class="btn btn-modern btn-primary-modern">
                        <i class="fas fa-save"></i> Guardar Cambios
                      </button>
                    </div>
                  </div>
                </form>
              </div>
            </div>
          </div>
          <div class="col-12 col-lg-4">
            <div class="content-card">
              <div class="card-header-modern">
                <i class="fas fa-key"></i> Cambiar Contraseña
              </div>
              <div class="card-body-modern">
                <form id="changePasswordForm">
                  <div class="mb-3">
                    <label class="form-label-modern">Contraseña Actual</label>
                    <input type="password" id="currentPassword" class="form-control form-control-modern" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label-modern">Nueva Contraseña</label>
                    <input type="password" id="newPassword" class="form-control form-control-modern" required>
                  </div>
                  <div class="mb-3">
                    <label class="form-label-modern">Confirmar Nueva Contraseña</label>
                    <input type="password" id="confirmNewPassword" class="form-control form-control-modern" required>
                  </div>
                  <div class="text-end">
                    <button type="submit" class="btn btn-modern btn-primary-modern">
                      <i class="fas fa-lock"></i> Cambiar
                    </button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </section>

      <div class="modal fade" id="loanDetailsModal" tabindex="-1" aria-labelledby="loanDetailsModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="loanDetailsModalLabel">Detalles del Préstamo</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <div id="modalBodyContent">
                <p><strong>ID Préstamo:</strong> <span id="modalLoanId"></span></p>
                <p><strong>Monto Original:</strong> <span id="modalOriginalAmount"></span></p>
                <p><strong>Saldo Pendiente:</strong> <span id="modalPendingBalance"></span></p>
                <p><strong>Tasa de Interés:</strong> <span id="modalInterestRate"></span></p>
                <p><strong>Cuotas Totales:</strong> <span id="modalInstallments"></span></p>
                <p><strong>Cuotas Pagadas:</strong> <span id="modalPaidInstallments"></span></p>
                <p><strong>Fecha de Desembolso:</strong> <span id="modalDisbursementDate"></span></p>
                <hr>
                <h6>Plan de Pagos</h6>
                <div class="table-responsive">
                  <table class="table table-striped">
                    <thead>
                      <tr>
                        <th>#</th>
                        <th>Fecha</th>
                        <th>Monto</th>
                        <th>Estado</th>
                      </tr>
                    </thead>
                    <tbody id="modalPaymentsTable">
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            </div>
          </div>
        </div>
      </div>

    </main>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.3.2/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  
  <script>
    // **AQUÍ DEBES PEGAR LA URL DE TU APLICACIÓN WEB DE GOOGLE APPS SCRIPT**
    const BACKEND_URL = 'https://script.google.com/macros/s/AKfycbxCILJhPhwUWLdc1ws6THP2UUkL7z8SwJbl5yPU6Lc6yRXoJcBmqqyofI9MCKjNfBFygg/exec'; 

    // Variables globales
    let sessionToken = localStorage.getItem('sessionToken');
    let username = localStorage.getItem('username');
    let currentLoanId = null;

    // Elementos del DOM
    const sidebar = document.getElementById('sidebar');
    const mobileToggle = document.getElementById('mobileToggle');
    const navLinks = document.querySelectorAll('.nav-link');
    const sections = document.querySelectorAll('.section');
    const logoutBtn = document.getElementById('logoutBtn');
    const profileForm = document.getElementById('profileForm');
    const changePasswordForm = document.getElementById('changePasswordForm');
    const loansTableBody = document.getElementById('loansTableBody');
    const contractsTableBody = document.getElementById('contractsTableBody');

    // Inicializar Charts
    let paymentsChart = null;
    let loanStatusChart = null;

    // Estado del modal para contrato
    let CURRENT_MODAL_CONTRACT = null;

    // ===================================
    // FUNCIÓN DE CONEXIÓN AL BACKEND
    // ===================================
    async function makeRequest(action, data = {}) {
    const url = 'https://script.google.com/macros/s/AKfycbxCILJhPhwUWLdc1ws6THP2UUkL7z8SwJbl5yPU6Lc6yRXoJcBmqqyofI9MCKjNfBFygg/exec';
    const form = new FormData();
    form.append('payload', JSON.stringify({ ...data, action, sessionToken }));

    try {
        const response = await fetch(url, {
            method: 'POST',
            body: form      // ✅ igual que admin
        });
        return await response.json();
    } catch (error) {
        console.error('Error en makeRequest:', error);
        return { success: false, message: 'Error de conexión' };
    }
}

    // ===================================
    // MANEJO DE SECCIONES Y NAVEGACIÓN
    // ===================================

    function showSection(sectionId) {
      sections.forEach(s => s.classList.remove('active'));
      document.getElementById(sectionId).classList.add('active');
      navLinks.forEach(link => {
        if (link.dataset.section === sectionId) {
          link.classList.add('active');
        } else {
          link.classList.remove('active');
        }
      });
      // Ocultar sidebar en móvil al cambiar de sección
      if (window.innerWidth <= 768) {
        sidebar.classList.remove('open');
      }
    }

    // Event listeners para la navegación
    navLinks.forEach(link => {
      link.addEventListener('click', (e) => {
        e.preventDefault();
        const sectionId = link.dataset.section;
        showSection(sectionId);
        // Cargar datos específicos de la sección
        if (sectionId === 'dashboard') {
          loadDashboardData();
        } else if (sectionId === 'loans') {
          loadLoans();
        } else if (sectionId === 'contracts') {
          loadContracts();
        } else if (sectionId === 'profile') {
          loadProfile();
        }
      });
    });

    // Event listener para el botón de menú en móviles
    mobileToggle.addEventListener('click', () => {
      sidebar.classList.toggle('open');
    });

    // ===================================
    // FUNCIONES DE UTILIDAD
    // ===================================

    function showAlert(message, type = 'danger') {
      const alertPlaceholder = document.getElementById('alertPlaceholder');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type} alert-dismissible fade show alert-fixed`;
      alert.innerHTML = `
        <div>${message}</div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
      `;
      alertPlaceholder.appendChild(alert);
      setTimeout(() => alert.classList.remove('show'), 5000);
    }
    
    function formatMoney(value) {
        return new Intl.NumberFormat('es-CO', { style: 'currency', currency: 'COP' }).format(value);
    }

    // ===================================
    // AUTENTICACIÓN Y CARGA INICIAL
    // ===================================

    async function checkAuthAndLoadData() {
        if (!sessionToken || !username) {
            showAlert('Tu sesión ha expirado o no has iniciado sesión.', 'warning');
            setTimeout(() => {
                window.location.href = 'login.html';
            }, 2000);
            return;
        }
        
        // Actualizar nombres de usuario en la interfaz
        document.getElementById('clientNameTitle').textContent = username;
        document.getElementById('clientNameHeadline').textContent = username;

        // Cargar datos del dashboard por defecto
        loadDashboardData();
    }

    window.addEventListener('load', checkAuthAndLoadData);

    // ===================================
    // FUNCIONES PARA CARGAR DATOS
    // ===================================

    async function loadDashboardData() {
        // Mostrar spinners de carga
        document.getElementById('totalPendingAmount').innerHTML = '<div class="loading-spinner"></div>';
        document.getElementById('activeLoansCount').innerHTML = '<div class="loading-spinner"></div>';
        document.getElementById('finalizedLoansCount').innerHTML = '<div class="loading-spinner"></div>';
        document.getElementById('averageInterestRate').innerHTML = '<div class="loading-spinner"></div>';
        document.getElementById('upcomingPayments').innerHTML = '<div class="text-center"><div class="loading-spinner mx-auto mb-2"></div><small class="text-muted">Cargando vencimientos...</small></div>';
        document.getElementById('recentActivityContainer').innerHTML = '<div class="text-center p-4"><div class="loading-spinner mx-auto mb-2"></div><small class="text-muted">Cargando actividad...</small></div>';

        try {
            const data = await makeRequest('getDashboardData');
            if (data.success) {
                const stats = data.stats;
                document.getElementById('totalPendingAmount').textContent = formatMoney(stats.totalPendingAmount || 0);
                document.getElementById('activeLoansCount').textContent = stats.activeLoansCount || 0;
                document.getElementById('finalizedLoansCount').textContent = stats.finalizedLoansCount || 0;
                document.getElementById('averageInterestRate').textContent = `${(stats.averageInterestRate * 100).toFixed(2)}%`;
                
                renderPaymentsChart(data.paymentsEvolution);
                renderLoanStatusChart(data.loanStatus);
                renderUpcomingPayments(data.upcomingPayments);
                renderRecentActivity(data.recentActivity);
            } else {
                showAlert(data.message);
            }
        } catch (error) {
            console.error("Error al cargar datos del dashboard:", error);
            showAlert('Error al cargar datos del dashboard.');
        }
    }

    async function loadLoans() {
        loansTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4"><div class="loading-spinner mx-auto mb-2"></div><small class="text-muted">Cargando préstamos...</small></td></tr>`;

        try {
            const data = await makeRequest('getClientLoans');
            if (data.success) {
                renderLoansTable(data.loans);
            } else {
                showAlert(data.message);
                loansTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4"><small class="text-muted">${data.message}</small></td></tr>`;
            }
        } catch (error) {
            console.error("Error al cargar préstamos:", error);
            showAlert('Error al cargar los préstamos.');
            loansTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4"><small class="text-danger">Error al cargar los préstamos.</small></td></tr>`;
        }
    }

    async function loadContracts() {
        contractsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><div class="loading-spinner mx-auto mb-2"></div><small class="text-muted">Cargando documentos...</small></td></tr>`;

        try {
            const data = await makeRequest('getClientContracts');
            if (data.success) {
                renderContractsTable(data.contracts);
            } else {
                showAlert(data.message);
                contractsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><small class="text-muted">${data.message}</small></td></tr>`;
            }
        } catch (error) {
            console.error("Error al cargar contratos:", error);
            showAlert('Error al cargar los contratos.');
            contractsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><small class="text-danger">Error al cargar los contratos.</small></td></tr>`;
        }
    }

    async function loadProfile() {
        try {
            const data = await makeRequest('getClientInfo');
            if (data.success) {
                const client = data.clientInfo;
                document.getElementById('profileDoc').value = client.docNumber;
                document.getElementById('profileName').value = client.fullName;
                document.getElementById('profilePhone').value = client.phone;
                document.getElementById('profileAddress').value = client.address;
                document.getElementById('profileColor').value = client.favoriteColor;
                document.getElementById('profileAnimal').value = client.favoriteAnimal;
            } else {
                showAlert(data.message);
            }
        } catch (error) {
            console.error("Error al cargar perfil:", error);
            showAlert('Error al cargar la información del perfil.');
        }
    }

    // ===================================
    // FUNCIONES DE RENDERIZADO
    // ===================================

    function renderPaymentsChart(data) {
      if (paymentsChart) {
        paymentsChart.destroy();
      }
      const ctx = document.getElementById('paymentsChart').getContext('2d');
      paymentsChart = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.map(d => d.date),
          datasets: [{
            label: 'Monto Pagado',
            data: data.map(d => d.amount),
            borderColor: 'rgb(54, 162, 235)',
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            fill: true,
            tension: 0.3
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            y: { beginAtZero: true }
          },
          plugins: {
            legend: { display: false }
          }
        }
      });
    }

    function renderLoanStatusChart(data) {
      if (loanStatusChart) {
        loanStatusChart.destroy();
      }
      const ctx = document.getElementById('loanStatusChart').getContext('2d');
      loanStatusChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: ['Activos', 'Finalizados', 'En Mora'],
          datasets: [{
            label: 'Estado de Préstamos',
            data: [data.active, data.finalized, data.overdue],
            backgroundColor: [
              '#3182ce',
              '#38a169',
              '#e53e3e'
            ],
            hoverOffset: 4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'bottom' },
          }
        }
      });
    }
    
    function renderUpcomingPayments(data) {
        const container = document.getElementById('upcomingPayments');
        if (data.length === 0) {
            container.innerHTML = '<div class="text-center py-4"><small class="text-muted">No hay próximos vencimientos.</small></div>';
            return;
        }

        let html = '';
        data.forEach(payment => {
            html += `
                <div class="activity-item">
                    <div class="activity-icon" style="background: var(--gradient-warning);"><i class="fas fa-calendar-day"></i></div>
                    <div class="activity-content">
                        <div class="activity-title">Cuota de préstamo #${payment.loanId}</div>
                        <div class="activity-subtitle">Vence el ${new Date(payment.dueDate).toLocaleDateString()}</div>
                    </div>
                    <div class="activity-amount text-warning">${formatMoney(payment.amount)}</div>
                </div>
            `;
        });
        container.innerHTML = html;
    }

    function renderRecentActivity(data) {
      const container = document.getElementById('recentActivityContainer');
        if (data.length === 0) {
            container.innerHTML = '<div class="text-center py-4"><small class="text-muted">No hay actividad reciente.</small></div>';
            return;
        }

      let html = '';
      data.forEach(activity => {
        const icon = activity.type === 'Pago' ? '<i class="fas fa-hand-holding-usd"></i>' : '<i class="fas fa-money-bill-wave"></i>';
        const color = activity.type === 'Pago' ? 'var(--gradient-success)' : 'var(--gradient-primary)';
        const amountColor = activity.type === 'Pago' ? 'var(--success)' : 'var(--primary)';
        
        html += `
          <div class="activity-item">
            <div class="activity-icon" style="background: ${color};">${icon}</div>
            <div class="activity-content">
              <div class="activity-title">${activity.title}</div>
              <div class="activity-subtitle">${activity.date}</div>
            </div>
            <div class="activity-amount" style="color: ${amountColor};">${formatMoney(activity.amount)}</div>
          </div>
        `;
      });
      container.innerHTML = html;
    }

    function renderLoansTable(loans) {
      loansTableBody.innerHTML = '';
      if (loans.length === 0) {
        loansTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-4"><small class="text-muted">No tienes préstamos registrados.</small></td></tr>`;
        return;
      }
      
      loans.forEach(loan => {
        const statusBadge = `<span class="badge-modern badge-${loan.status === 'ACTIVO' ? 'success' : 'secondary'}">${loan.status}</span>`;
        const row = `
          <tr>
            <td>${loan.id}</td>
            <td>${formatMoney(loan.originalAmount)}</td>
            <td>${formatMoney(loan.pendingAmount)}</td>
            <td>${loan.paidInstallments}/${loan.totalInstallments}</td>
            <td>${(loan.interestRate * 100).toFixed(2)}%</td>
            <td>${statusBadge}</td>
            <td>
              <button class="btn btn-sm-modern btn-primary-modern" onclick="openLoanDetailsModal('${loan.id}')">
                <i class="fas fa-eye"></i>
              </button>
            </td>
          </tr>
        `;
        loansTableBody.innerHTML += row;
      });
    }
    
    function renderContractsTable(contracts) {
        contractsTableBody.innerHTML = '';
        if (contracts.length === 0) {
            contractsTableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4"><small class="text-muted">No tienes contratos registrados.</small></td></tr>`;
            return;
        }

        contracts.forEach(contract => {
            const row = `
                <tr>
                    <td>${contract.id}</td>
                    <td>Préstamo #${contract.loanId}</td>
                    <td>${new Date(contract.date).toLocaleDateString()}</td>
                    <td>Tipo: Contrato</td>
                    <td><span class="badge-modern badge-success">Generado</span></td>
                    <td>
                        <button class="btn btn-sm-modern btn-primary-modern" onclick="downloadContract('${contract.loanId}')">
                            <i class="fas fa-download"></i>
                        </button>
                    </td>
                </tr>
            `;
            contractsTableBody.innerHTML += row;
        });
    }

    // ===================================
    // MANEJO DE MODALES
    // ===================================
    
    async function openLoanDetailsModal(loanId) {
        try {
            const data = await makeRequest('getLoanDetails', { loanId });
            if (data.success) {
                const loan = data.loan;
                const paymentPlan = data.paymentPlan;
                
                document.getElementById('modalLoanId').textContent = loan.id;
                document.getElementById('modalOriginalAmount').textContent = formatMoney(loan.originalAmount);
                document.getElementById('modalPendingBalance').textContent = formatMoney(loan.pendingAmount);
                document.getElementById('modalInterestRate').textContent = `${(loan.interestRate * 100).toFixed(2)}%`;
                document.getElementById('modalInstallments').textContent = loan.totalInstallments;
                document.getElementById('modalPaidInstallments').textContent = loan.paidInstallments;
                document.getElementById('modalDisbursementDate').textContent = new Date(loan.disbursementDate).toLocaleDateString();

                const paymentsTableBody = document.getElementById('modalPaymentsTable');
                paymentsTableBody.innerHTML = '';
                paymentPlan.forEach((p, index) => {
                    const status = p[3] ? 'Pagada' : 'Pendiente';
                    const statusClass = p[3] ? 'text-success' : 'text-danger';
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${new Date(p[0]).toLocaleDateString()}</td>
                            <td>${formatMoney(p[1])}</td>
                            <td class="${statusClass}">${status}</td>
                        </tr>
                    `;
                    paymentsTableBody.innerHTML += row;
                });
                
                new bootstrap.Modal(document.getElementById('loanDetailsModal')).show();
            } else {
                showAlert(data.message);
            }
        } catch (error) {
            console.error("Error al obtener detalles del préstamo:", error);
            showAlert('Error al obtener los detalles del préstamo.');
        }
    }

    // ===================================
    // FORMULARIOS Y ACCIONES
    // ===================================

    profileForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const data = {
            fullName: document.getElementById('profileName').value,
            phone: document.getElementById('profilePhone').value,
            address: document.getElementById('profileAddress').value,
            favoriteColor: document.getElementById('profileColor').value,
            favoriteAnimal: document.getElementById('profileAnimal').value,
            sessionToken: sessionToken
        };
        try {
            const response = await makeRequest('updateClientInfo', data);
            if (response.success) {
                showAlert('Perfil actualizado correctamente.', 'success');
            } else {
                showAlert(response.message);
            }
        } catch (error) {
            console.error("Error al actualizar perfil:", error);
            showAlert('Error al actualizar el perfil.');
        }
    });

    changePasswordForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const currentPassword = document.getElementById('currentPassword').value;
        const newPassword = document.getElementById('newPassword').value;
        const confirmNewPassword = document.getElementById('confirmNewPassword').value;

        if (newPassword !== confirmNewPassword) {
            showAlert('Las contraseñas no coinciden.');
            return;
        }

        const data = {
            currentPassword: currentPassword,
            newPassword: newPassword,
            sessionToken: sessionToken
        };
        try {
            const response = await makeRequest('changePassword', data);
            if (response.success) {
                showAlert('Contraseña cambiada correctamente.', 'success');
                changePasswordForm.reset();
            } else {
                showAlert(response.message);
            }
        } catch (error) {
            console.error("Error al cambiar la contraseña:", error);
            showAlert('Error al cambiar la contraseña.');
        }
    });

    // ===================================
    // LOGOUT
    // ===================================

    logoutBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        await makeRequest('logout', { sessionToken });
      } catch (error) {
        console.error('Error durante el cierre de sesión:', error);
      } finally {
        localStorage.removeItem('sessionToken');
        localStorage.removeItem('username');
        showAlert('Sesión cerrada correctamente', 'success');
        setTimeout(() => {
          window.location.href = 'login.html';
        }, 1000);
      }
    });

    // ===================================
    // MANEJO DE CONTRATOS
    // ===================================
    
    // Función para descargar un contrato (usando html2canvas y jspdf)
    async function downloadContract(loanId) {
        showAlert('Generando documento... Esto puede tomar unos segundos.', 'info');
        try {
            const data = await makeRequest('generateContract', { loanId });
            if (data.success) {
                const contractData = data.data.contract;
                const htmlContent = `
                    <div style="font-family: Arial, sans-serif; padding: 2rem; max-width: 800px; margin: auto;">
                        <h2 style="text-align: center; color: #3182ce;">Contrato de Préstamo</h2>
                        <p style="text-align: center; color: #4a5568;"><strong>ID Préstamo:</strong> ${contractData.loanId}</p>
                        <hr style="border-top: 1px solid #e2e8f0;">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div><strong>Cliente:</strong> ${contractData.clientName}</div>
                            <div><strong>Fecha:</strong> ${new Date(contractData.date).toLocaleDateString()}</div>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 1rem;">
                            <div><strong>Documento:</strong> ${contractData.clientDoc}</div>
                            <div><strong>Monto:</strong> ${formatMoney(contractData.amount)}</div>
                        </div>
                        <p style="margin-top: 2rem;">El presente documento certifica el acuerdo de préstamo entre las partes, con las siguientes condiciones:</p>
                        <ul>
                            <li><strong>Monto Principal:</strong> ${formatMoney(contractData.amount)}</li>
                            <li><strong>Cuotas:</strong> ${contractData.installments}</li>
                            <li><strong>Tasa de Interés:</strong> ${(contractData.interestRate * 100).toFixed(2)}%</li>
                        </ul>
                        <h4 style="margin-top: 2rem; color: #2d3748;">Plan de Pagos</h4>
                        <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
                            <thead style="background: #f8fafc;">
                                <tr>
                                    <th style="padding: 0.75rem; border: 1px solid #e2e8f0;"># Cuota</th>
                                    <th style="padding: 0.75rem; border: 1px solid #e2e8f0;">Fecha</th>
                                    <th style="padding: 0.75rem; border: 1px solid #e2e8f0;">Monto</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${contractData.paymentPlan.map((p, i) => `
                                    <tr>
                                        <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${i + 1}</td>
                                        <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${new Date(p.date).toLocaleDateString()}</td>
                                        <td style="padding: 0.75rem; border: 1px solid #e2e8f0;">${formatMoney(p.amount)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                        <div style="margin-top: 3rem; text-align: center; color: #718096; font-size: 0.9rem;">
                            Documento generado el ${new Date().toLocaleDateString()} por SGL Pro.
                        </div>
                    </div>
                `;
                const filename = `contrato_${contractData.loanId}.pdf`;
                await generatePdfAndDownload(htmlContent, filename);
                showAlert('Documento generado exitosamente.', 'success');
            } else {
                showAlert(data.message);
            }
        } catch (error) {
            console.error("Error al generar el contrato:", error);
            showAlert('Error al generar el contrato.');
        }
    }

    async function generatePdfAndDownload(htmlContent, filename) {
        const wrap = document.createElement('div');
        wrap.style.width = '210mm'; // A4 width
        wrap.innerHTML = htmlContent;
        document.body.appendChild(wrap);
        
        const canvas = await html2canvas(wrap);
        const imgData = canvas.toDataURL('image/png');
        
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('p', 'mm', 'a4');
        const imgProps = pdf.getImageProperties(imgData);
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        pdf.save(filename);
        
        document.body.removeChild(wrap);
    }
  </script>
</body>
</html>
